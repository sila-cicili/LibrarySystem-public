@{
    ViewData["Title"] = "KÃ¼tÃ¼phane HaritasÄ±";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2>ğŸ“ KÃ¼tÃ¼phane Åubeleri</h2>
            <p class="text-muted mb-0">CoÄŸrafi Bilgi Sistemi (GIS)</p>
        </div>
        
        @if (User.IsInRole("admin"))
        {
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBranchModal">
                â• Yeni Åube Ekle
            </button>
        }
    </div>
    
    <div id="map" style="height: 500px; width: 100%; border-radius: 10px; border: 2px solid #ddd; position: relative;"></div>
</div>

<div class="modal fade" id="addBranchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Yeni KÃ¼tÃ¼phane Ekle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addBranchForm">
                    <div class="mb-3">
                        <label class="form-label">Åube AdÄ±</label>
                        <input type="text" class="form-control" id="branchName" required placeholder="Ã–rn: Merkez KÃ¼tÃ¼phane">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Adres</label>
                        <textarea class="form-control" id="branchAddress" rows="2" required placeholder="Tam adres giriniz..."></textarea>
                    </div>
                    
                    <div class="alert alert-info p-2">
                        <small>Haritadan konum seÃ§mek iÃ§in aÅŸaÄŸÄ±daki butona basÄ±n.</small>
                    </div>

                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label">Enlem (Lat)</label>
                            <input type="text" class="form-control" id="branchLat" readonly>
                        </div>
                        <div class="col">
                            <label class="form-label">Boylam (Lng)</label>
                            <input type="text" class="form-control" id="branchLng" readonly>
                        </div>
                    </div>

                    <button type="button" class="btn btn-outline-secondary w-100 mb-3" onclick="startLocationSelection()">
                        ğŸ“ Haritadan Konum SeÃ§
                    </button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ä°ptal</button>
                <button type="button" class="btn btn-success" onclick="saveBranch()">ğŸ’¾ Kaydet</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. HaritayÄ± BaÅŸlat
    var map = L.map('map').setView([39.92, 32.85], 11);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Yetki kontrolÃ¼ (Razor -> JS)
    var isAdmin = @(User.IsInRole("admin").ToString().ToLower());

    // Konum seÃ§me deÄŸiÅŸkenleri
    var selectionMarker;
    var isSelectingLocation = false;

    // 2. Verileri Ã‡ek
    loadBranches();

    function loadBranches() {
        // Haritadaki eski pinleri temizlemek gerekirse buraya map.eachLayer... eklenebilir
        // Ama ÅŸimdilik basit tutalÄ±m.
        
        fetch('/api/LibraryApi')
            .then(response => response.json())
            .then(data => {
                data.forEach(branch => {
                    
                    // Baloncuk Ä°Ã§eriÄŸini HazÄ±rla
                    let popupContent = `<div class="text-center">
                                            <b>${branch.name}</b><br>
                                            <span class="text-muted" style="font-size:12px">${branch.address}</span>
                                        </div>`;

                    // EÄER ADMÄ°N Ä°SE SÄ°L BUTONU EKLE ğŸ—‘ï¸
                    if (isAdmin) {
                        popupContent += `<hr class="my-2">
                                         <button class="btn btn-danger btn-sm w-100" onclick="deleteBranch(${branch.id})">
                                            ğŸ—‘ï¸ Åubeyi Sil
                                         </button>`;
                    }

                    // Ä°ÅŸaretÃ§iyi haritaya ekle
                    L.marker([branch.lat, branch.lng])
                        .addTo(map)
                        .bindPopup(popupContent);
                });
            })
            .catch(error => console.error('Hata:', error));
    }

    // --- SÄ°LME FONKSÄ°YONU (YENÄ°) ---
    function deleteBranch(id) {
        if (confirm("Bu kÃ¼tÃ¼phane ÅŸubesini silmek istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz!")) {
            fetch(`/api/LibraryApi/${id}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    alert("ğŸ—‘ï¸ KÃ¼tÃ¼phane silindi.");
                    location.reload(); // HaritayÄ± yenile
                } else {
                    alert("Hata oluÅŸtu, silinemedi.");
                }
            })
            .catch(err => console.error(err));
        }
    }

    // --- EKLEME Ä°ÅLEMLERÄ° (ESKÄ° KODLARIN AYNISI) ---

    function startLocationSelection() {
        var modalEl = document.getElementById('addBranchModal');
        var modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();

        isSelectingLocation = true;
        alert("LÃ¼tfen haritada kÃ¼tÃ¼phanenin konumunu iÅŸaretleyin.");
        document.getElementById('map').style.cursor = "crosshair";
    }

    map.on('click', function(e) {
        if (isAdmin && isSelectingLocation) {
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;

            document.getElementById('branchLat').value = lat;
            document.getElementById('branchLng').value = lng;

            if (selectionMarker) map.removeLayer(selectionMarker);
            selectionMarker = L.marker([lat, lng]).addTo(map);

            var modal = new bootstrap.Modal(document.getElementById('addBranchModal'));
            modal.show();

            isSelectingLocation = false;
            document.getElementById('map').style.cursor = "";
        }
    });

    function saveBranch() {
        var name = document.getElementById('branchName').value;
        var address = document.getElementById('branchAddress').value;
        var lat = document.getElementById('branchLat').value;
        var lng = document.getElementById('branchLng').value;

        if (!name || !address || !lat) {
            alert("LÃ¼tfen tÃ¼m alanlarÄ± doldurun!");
            return;
        }

        fetch('/api/LibraryApi', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                address: address,
                lat: parseFloat(lat),
                lng: parseFloat(lng)
            })
        })
        .then(response => {
            if (response.ok) {
                alert("âœ… Eklendi!");
                location.reload();
            } else {
                alert("Hata oluÅŸtu!");
            }
        });
    }
</script>
